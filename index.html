<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Телефонни консултации</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --card:#0b1324;
      --card2:#0c152b;
      --border: rgba(148,163,184,.16);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --muted2:#a8b3c7;
      --accent:#60a5fa;
      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --shadow2: 0 8px 18px rgba(0,0,0,.30);
      --radius: 16px;
      --ring: 0 0 0 3px rgba(96,165,250,.25);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(96,165,250,.18), transparent 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(34,197,94,.10), transparent 55%),
        radial-gradient(800px 500px at 50% 110%, rgba(245,158,11,.10), transparent 55%),
        linear-gradient(180deg, #070b16, #050815);
    }

    .container{ max-width: 1200px; margin: 0 auto; padding: 22px; }

    /* Topbar */
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding: 14px 16px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.55));
      backdrop-filter: blur(10px);
      border-radius: 18px;
      box-shadow: var(--shadow2);
      position: sticky; top: 14px; z-index: 50;
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width: 220px; }
    .logo{
      width:40px; height:40px; border-radius: 14px;
      background:
        radial-gradient(16px 16px at 30% 25%, rgba(96,165,250,.95), rgba(96,165,250,.05)),
        radial-gradient(18px 18px at 70% 70%, rgba(34,197,94,.85), rgba(34,197,94,.05)),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    .brand h1{ margin:0; font-size: 16px; letter-spacing: .2px; }
    .brand .sub{ margin-top:2px; font-size: 12px; color: var(--muted); }

    .searchbar{
      flex: 1;
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(11,19,36,.55);
      min-width: 260px;
    }
    .searchbar input{
      width: 100%;
      border:0; outline:0;
      background: transparent;
      color: var(--text);
      font-size: 14px;
    }
    .searchbar .hint{ font-size: 12px; color: var(--muted); white-space: nowrap; }

    .top-actions{ display:flex; gap:10px; align-items:center; }
    .chip{
      display:flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(11,19,36,.55);
      color: var(--muted2);
      font-size: 12px;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: var(--ok); box-shadow: 0 0 0 4px rgba(34,197,94,.12); }
    .dot.err{ background: var(--danger); box-shadow: 0 0 0 4px rgba(239,68,68,.12); }

    /* Layout */
    .grid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
      .searchbar{ min-width: unset; }
    }

    /* Cards */
    .card{
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(12,21,43,.80), rgba(11,19,36,.55));
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .card-header{
      padding: 14px 14px 10px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      border-bottom: 1px solid rgba(148,163,184,.10);
    }
    .card-title{
      margin: 0;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .card-desc{
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .card-body{ padding: 14px; }

    /* Form */
    .form-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 540px){ .form-grid{ grid-template-columns: 1fr; } }

    label{ display:block; margin: 0 0 6px; font-size: 12px; color: var(--muted2); }
    input, select, button{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.35);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    input::placeholder{ color: rgba(148,163,184,.65); }
    input:focus, select:focus{ box-shadow: var(--ring); border-color: rgba(96,165,250,.45); }
    select{ appearance:none; background-image:
      linear-gradient(45deg, transparent 50%, rgba(148,163,184,.8) 50%),
      linear-gradient(135deg, rgba(148,163,184,.8) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(50% - 2px),
        calc(100% - 12px) calc(50% - 2px);
      background-size:6px 6px, 6px 6px;
      background-repeat:no-repeat;
      padding-right: 34px;
    }

    .btn-row{ display:flex; gap:10px; }
    .btn{
      cursor:pointer;
      transition: transform .05s ease, opacity .15s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border: 1px solid rgba(96,165,250,.45);
      background: linear-gradient(180deg, rgba(96,165,250,.22), rgba(96,165,250,.10));
    }
    .btn.primary:hover{ border-color: rgba(96,165,250,.7); }
    .btn.secondary{
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(11,19,36,.45);
      color: var(--text);
    }
    .btn.secondary:hover{ border-color: rgba(148,163,184,.30); }
    .btn.danger{
      border: 1px solid rgba(239,68,68,.40);
      background: linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.06));
      color: #ffd9dd;
    }
    .btn.danger:hover{ border-color: rgba(239,68,68,.68); }
    .btn.small{ padding: 8px 10px; font-size: 12px; border-radius: 11px; }
    .btn.inline{ width:auto; }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }

    /* Metrics */
    .metrics{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    @media (max-width: 980px){ .metrics{ grid-template-columns: 1fr 1fr; } }
    @media (max-width: 540px){ .metrics{ grid-template-columns: 1fr; } }

    .metric{
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(12,21,43,.72), rgba(11,19,36,.48));
      box-shadow: var(--shadow2);
      padding: 14px;
      min-height: 86px;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .metric .k{ font-size: 12px; color: var(--muted); }
    .metric .v{ font-size: 20px; letter-spacing: .3px; margin-top: 6px; }
    .metric .s{ font-size: 12px; color: var(--muted2); margin-top: 6px; }

    /* Table */
    .table-card{ margin-top: 14px; }
    .table-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
      padding: 14px;
      border-bottom: 1px solid rgba(148,163,184,.10);
    }
    .table-head .left h2{ margin:0; font-size: 14px; }
    .table-head .left .desc{ margin-top:4px; font-size: 12px; color: var(--muted); }
    .table-actions{ display:flex; gap:10px; align-items:end; flex-wrap:wrap; }
    .table-wrap{ overflow:auto; }
    table{ width:100%; border-collapse: separate; border-spacing: 0; }
    th, td{ padding: 12px 14px; text-align:left; border-bottom: 1px solid rgba(148,163,184,.10); white-space: nowrap; }
    th{
      position: sticky; top: 0;
      background: rgba(15,23,42,.85);
      backdrop-filter: blur(10px);
      font-size: 12px;
      color: var(--muted2);
      z-index: 1;
    }
    tr:hover td{ background: rgba(96,165,250,.05); }
    td.right, th.right{ text-align:right; }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.28);
      font-size: 12px;
      color: var(--muted2);
    }
    .badge .b{ width:8px; height:8px; border-radius:999px; }
    .badge.ok{ border-color: rgba(34,197,94,.25); }
    .badge.ok .b{ background: var(--ok); }
    .badge.warn{ border-color: rgba(245,158,11,.25); }
    .badge.warn .b{ background: var(--warn); }

    .mono{ font-family: var(--mono); }

    /* Toast */
    .toast{
      position: fixed; right: 18px; bottom: 18px;
      min-width: 260px; max-width: 420px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,.92);
      box-shadow: var(--shadow);
      display:none;
      z-index: 200;
    }
    .toast.show{ display:block; }
    .toast .t{ font-size: 13px; margin:0; }
    .toast .d{ font-size: 12px; color: var(--muted); margin-top: 4px; }
    .toast.ok{ border-color: rgba(34,197,94,.25); }
    .toast.warn{ border-color: rgba(245,158,11,.25); }
    .toast.err{ border-color: rgba(239,68,68,.30); }

    /* Busy overlay */
    .busy-overlay{
      position: fixed; inset: 0;
      display:none;
      background: rgba(2,6,23,.25);
      backdrop-filter: blur(2px);
      z-index: 150;
    }
    body.busy .busy-overlay{ display:block; }
    .spinner{
      position:absolute; right: 18px; top: 18px;
      width: 32px; height: 32px; border-radius: 999px;
      border: 3px solid rgba(148,163,184,.25);
      border-top-color: rgba(96,165,250,.85);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }

    /* Modal */
    .modal-backdrop{
      position: fixed; inset: 0;
      display:none;
      background: rgba(2,6,23,.55);
      backdrop-filter: blur(6px);
      z-index: 300;
      padding: 18px;
    }
    .modal-backdrop.show{ display:flex; align-items:center; justify-content:center; }
    .modal{
      width: min(860px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.18);
      background: linear-gradient(180deg, rgba(15,23,42,.95), rgba(11,19,36,.85));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-header{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(148,163,184,.10);
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
    }
    .modal-title{ margin:0; font-size: 14px; }
    .modal-sub{ margin-top:4px; font-size:12px; color: var(--muted); }
    .modal-body{ padding: 14px; }
    .modal-footer{
      padding: 12px 14px;
      border-top: 1px solid rgba(148,163,184,.10);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .modal-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 780px){ .modal-grid{ grid-template-columns: 1fr; } }

    .panel{
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.25);
      border-radius: 14px;
      padding: 12px;
    }
    .panel h3{ margin:0 0 8px; font-size: 12px; color: var(--muted2); font-weight: 600; }
    .list{
      max-height: 220px;
      overflow:auto;
      border: 1px solid rgba(148,163,184,.10);
      border-radius: 12px;
      background: rgba(2,6,23,.18);
      padding: 8px;
    }
    .list .item{
      padding: 8px 10px;
      border-radius: 10px;
      display:flex; justify-content:space-between; gap:10px;
      color: var(--muted2);
      border: 1px solid transparent;
    }
    .list .item:hover{
      background: rgba(96,165,250,.05);
      border-color: rgba(96,165,250,.12);
    }
    .kv{ display:grid; grid-template-columns: 170px 1fr; gap: 8px 10px; font-size: 13px; }
    .kv .k{ color: var(--muted); }
  </style>
</head>

<body>
  <div class="busy-overlay"><div class="spinner"></div></div>

  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Телефонни консултации</h1>
          <div class="sub">Admin dashboard</div>
        </div>
      </div>

      <div class="searchbar" title="Филтрира таблицата по пациент">
        <span class="mono" style="color:var(--muted);font-size:12px;">⌕</span>
        <input id="search" placeholder="Търсене по пациент..." />
        <span class="hint">Enter</span>
      </div>

      <div class="top-actions">
        <div class="chip"><span class="dot" id="connDot"></span><span id="connText">Свързан</span></div>
        <button class="btn secondary inline" id="exportBtnTop">Експорт</button>
      </div>
    </div>

    <div class="metrics">
      <div class="metric">
        <div class="k">Пациенти</div>
        <div class="v" id="mPatients">—</div>
        <div class="s" id="mPatientsSub">—</div>
      </div>
      <div class="metric">
        <div class="k">Пакети</div>
        <div class="v" id="mPackages">—</div>
        <div class="s" id="mPackagesSub">—</div>
      </div>
      <div class="metric">
        <div class="k">Консултации</div>
        <div class="v" id="mConsults">—</div>
        <div class="s">Общо записи</div>
      </div>
      <div class="metric">
        <div class="k">Изчерпани пакети</div>
        <div class="v" id="mExhausted">—</div>
        <div class="s">Оставащи = 0</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Нов пациент</h2>
            <div class="card-desc">Създава пациент. После добави пакет.</div>
          </div>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <div style="grid-column:1 / -1;">
              <label>Име и фамилия</label>
              <input id="fullName" placeholder="напр. Иван Петров" />
            </div>
          </div>
          <div style="margin-top:12px;" class="btn-row">
            <button class="btn primary" id="addPatientBtn">Добави пациент</button>
            <button class="btn secondary" id="clearPatientBtn">Изчисти</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Операции</h2>
            <div class="card-desc">Добави пакет или консултация към избран пациент.</div>
          </div>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <div>
              <label>Пациент (за пакет)</label>
              <select id="patientForPackage"></select>
            </div>
            <div>
              <label>Дата на покупка</label>
              <input type="date" id="packageDate" />
            </div>
            <div>
              <label>Брой консултации</label>
              <input type="number" id="packageSize" value="5" min="1" />
            </div>
            <div style="display:flex;align-items:end;">
              <button class="btn primary" id="addPackageBtn">Добави пакет</button>
            </div>
          </div>

          <div style="height:10px;"></div>

          <div class="form-grid">
            <div>
              <label>Пациент (за консултация)</label>
              <select id="patientForConsult"></select>
            </div>
            <div>
              <label>Дата на консултация</label>
              <input type="date" id="consultDate" />
            </div>
            <div style="display:flex;align-items:end;">
              <button class="btn primary" id="addConsultBtn">Добави консултация</button>
            </div>
            <div style="display:flex;align-items:end;">
              <button class="btn secondary" id="todayBtn">Днес</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card table-card" style="margin-top:14px;">
      <div class="table-head">
        <div class="left">
          <h2>Отчет по пакети</h2>
          <div class="desc">Филтър + сортиране + детайли. „Нов пакет“ се отключва при Изчерпан.</div>
        </div>

        <div class="table-actions">
          <div>
            <label>Филтър</label>
            <select id="filterStatus">
              <option value="all">Всички</option>
              <option value="active">Само активни</option>
              <option value="exhausted">Само изчерпани</option>
            </select>
          </div>

          <div>
            <label>Сортиране</label>
            <select id="sortBy">
              <option value="date_desc">Дата (нови → стари)</option>
              <option value="date_asc">Дата (стари → нови)</option>
              <option value="patient_asc">Пациент (A → Я)</option>
              <option value="status">Статус (Активен → Изчерпан)</option>
            </select>
          </div>

          <div style="display:flex;align-items:end;">
            <button class="btn secondary inline" id="exportBtn">Експорт (Excel)</button>
          </div>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Пациент</th>
              <th>Пакет</th>
              <th>Статус</th>
              <th>Проведени / Остават</th>
              <th class="right">Действия</th>
            </tr>
          </thead>
          <tbody id="packagesTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div>
          <h2 class="modal-title" id="modalTitle">Детайли</h2>
          <div class="modal-sub" id="modalSub">—</div>
        </div>
        <button class="btn secondary small inline" id="modalCloseBtn">Затвори</button>
      </div>

      <div class="modal-body">
        <div class="modal-grid">
          <div class="panel">
            <h3>Обобщение</h3>
            <div class="kv">
              <div class="k">Пациент</div><div id="dPatient">—</div>
              <div class="k">Покупка</div><div id="dPurchase">—</div>
              <div class="k">Размер</div><div id="dSize">—</div>
              <div class="k">Проведени</div><div id="dDone">—</div>
              <div class="k">Оставащи</div><div id="dLeft">—</div>
              <div class="k">Статус</div><div id="dStatus">—</div>
            </div>

            <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn primary small inline" id="dQuickNewBtn">Нов пакет (бързо)</button>
              <button class="btn danger small inline" id="dDeleteBtn">Изтрий пакет</button>
            </div>

            <div style="margin-top:10px; font-size:12px; color:var(--muted);">
              “Нов пакет (бързо)” се активира само когато пакетът е изчерпан.
            </div>
          </div>

          <div class="panel">
            <h3>Консултации (дати)</h3>
            <div class="list" id="dList"></div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div style="font-size:12px;color:var(--muted);">
          ID: <span class="mono" id="dPkgId">—</span>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn secondary small inline" id="modalExportBtn">Експорт</button>
          <button class="btn secondary small inline" id="modalCloseBtn2">Затвори</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <p class="t" id="toastTitle">—</p>
    <p class="d" id="toastDesc"></p>
  </div>

  <!-- SheetJS за .xlsx -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
(() => {
  const SCRIPT_URL = "/.netlify/functions/api";

  let state = { patients: [], packages: [], consultations: [] };
  let busy = false;

  // Modal state
  let modalPkgId = null;

  const el = (id) => document.getElementById(id);

  function setBusy(v) {
    busy = v;
    document.body.classList.toggle("busy", v);
  }

  function toast(kind, title, desc="") {
    const t = el("toast");
    const tt = el("toastTitle");
    const td = el("toastDesc");
    t.className = "toast show " + (kind || "");
    tt.textContent = title;
    td.textContent = desc || "";
    clearTimeout(toast._timer);
    toast._timer = setTimeout(() => t.className = "toast", 2600);
  }

  function setConn(ok, msg="") {
    el("connDot").className = "dot" + (ok ? "" : " err");
    el("connText").textContent = ok ? "Свързан" : (msg || "Проблем");
  }

  function formatDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    const pad = n => String(n).padStart(2, "0");
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
  }

  function todayISO() {
    return new Date().toISOString().slice(0, 10);
  }

  function safeBool(v) {
    return String(v).toLowerCase() === "true";
  }

  async function api(action, payload = {}) {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action, payload })
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || "API error");
    return json.data;
  }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function computePackageStats(pkgId, size) {
    const used = state.consultations.filter(c => c.packageId === pkgId).length;
    const left = Math.max(0, Number(size) - used);
    return { used, left, status: left > 0 ? "Активен" : "Изчерпан" };
  }

  function getPatientName(patientId) {
    const p = state.patients.find(x => x.patientId === patientId);
    return p ? `${p.firstName} ${p.lastName}` : "(липсващ пациент)";
  }

  function renderMetrics() {
    const patientsTotal = state.patients.length;
    const patientsActive = state.patients.filter(p => !safeBool(p.archived)).length;

    const packagesTotal = state.packages.length;
    const consultsTotal = state.consultations.length;

    const exhausted = state.packages.filter(pkg => computePackageStats(pkg.packageId, pkg.size).left === 0).length;

    el("mPatients").textContent = patientsActive.toString();
    el("mPatientsSub").textContent = `${patientsTotal - patientsActive} архивирани`;

    el("mPackages").textContent = packagesTotal.toString();
    el("mPackagesSub").textContent = `всички пакети`;

    el("mConsults").textContent = consultsTotal.toString();
    el("mExhausted").textContent = exhausted.toString();
  }

  function renderSelects() {
    const patients = state.patients
      .filter(p => !safeBool(p.archived))
      .slice()
      .sort((a,b) => (`${a.firstName} ${a.lastName}`).localeCompare(`${b.firstName} ${b.lastName}`,"bg"));

    const selects = [el("patientForPackage"), el("patientForConsult")];
    selects.forEach(s => {
      const current = s.value;
      s.innerHTML = "";
      for (const p of patients) {
        const o = document.createElement("option");
        o.value = p.patientId;
        o.textContent = `${p.firstName} ${p.lastName}`;
        s.appendChild(o);
      }
      if (current && patients.some(p => p.patientId === current)) s.value = current;
      s.disabled = patients.length === 0;
    });
  }

  function buildRows() {
    const q = (el("search").value || "").trim().toLowerCase();
    const filter = el("filterStatus").value;
    const sortBy = el("sortBy").value;

    const patientMap = new Map(state.patients.map(p => [p.patientId, p]));

    let rows = state.packages
      .map(pkg => ({ pkg, p: patientMap.get(pkg.patientId) }))
      .filter(x => x.p)
      .filter(({p}) => !q || (`${p.firstName} ${p.lastName}`.toLowerCase().includes(q)));

    if (filter !== "all") {
      rows = rows.filter(({pkg}) => {
        const { left } = computePackageStats(pkg.packageId, pkg.size);
        return filter === "active" ? left > 0 : left === 0;
      });
    }

    rows.sort((a,b) => {
      const aName = `${a.p.firstName} ${a.p.lastName}`;
      const bName = `${b.p.firstName} ${b.p.lastName}`;
      const aStats = computePackageStats(a.pkg.packageId, a.pkg.size);
      const bStats = computePackageStats(b.pkg.packageId, b.pkg.size);

      if (sortBy === "date_asc") return String(a.pkg.purchaseDate).localeCompare(String(b.pkg.purchaseDate));
      if (sortBy === "date_desc") return String(b.pkg.purchaseDate).localeCompare(String(a.pkg.purchaseDate));
      if (sortBy === "patient_asc") return aName.localeCompare(bName, "bg");
      if (sortBy === "status") {
        const aVal = aStats.left > 0 ? 0 : 1;
        const bVal = bStats.left > 0 ? 0 : 1;
        if (aVal !== bVal) return aVal - bVal;
        return String(b.pkg.purchaseDate).localeCompare(String(a.pkg.purchaseDate));
      }
      return 0;
    });

    return rows;
  }

  function renderTable() {
    const tbody = el("packagesTable");
    tbody.innerHTML = "";

    const rows = buildRows();

    if (rows.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" style="color:var(--muted); padding: 18px 14px;">Няма резултати.</td>`;
      tbody.appendChild(tr);
      return;
    }

    for (const {pkg, p} of rows) {
      const { used, left } = computePackageStats(pkg.packageId, pkg.size);

      const statusBadge = left > 0
        ? `<span class="badge ok"><span class="b"></span>Активен</span>`
        : `<span class="badge warn"><span class="b"></span>Изчерпан</span>`;

      const quickDisabled = left > 0 ? "disabled" : "";
      const quickTitle = left > 0 ? "Отключва се при Изчерпан" : "Добавя нов пакет за същия пациент (днес)";
      const quickClass = left > 0 ? "secondary" : "primary";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div style="display:flex;flex-direction:column;gap:4px;">
            <div style="font-weight:600;">${escapeHtml(p.firstName + " " + p.lastName)}</div>
          </div>
        </td>
        <td>${escapeHtml(formatDate(pkg.purchaseDate))}</td>
        <td>${statusBadge}</td>
        <td>
          <div style="display:flex;align-items:center;gap:10px;">
            <span class="badge" title="Проведени / Остават">${used} / ${left}</span>
            <span style="font-size:12px;color:var(--muted);">Размер: ${Number(pkg.size)}</span>
          </div>
        </td>
        <td class="right">
          <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
            <button class="btn secondary small inline" data-action="details" data-id="${pkg.packageId}" style="width:auto;">Детайли</button>
            <button class="btn ${quickClass} small inline" ${quickDisabled} title="${escapeHtml(quickTitle)}"
              data-action="quickNew" data-id="${pkg.packageId}" style="width:auto;">
              Нов пакет
            </button>
            <button class="btn danger small inline" data-action="deletePkg" data-id="${pkg.packageId}" style="width:auto;">Изтрий</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function refresh() {
    setBusy(true);
    try {
      state = await api("getState");
      setConn(true);
      renderSelects();
      renderMetrics();
      renderTable();
      if (modalPkgId) openDetails(modalPkgId, true);
    } catch (e) {
      setConn(false, "Грешка");
      toast("err", "Грешка при зареждане", e.message);
    }
    setBusy(false);
  }

  function exportToExcel() {
    if (!window.XLSX) {
      toast("err", "Липсва XLSX библиотека", "Провери интернет връзката/скрипта.");
      return;
    }

    const patientMap = new Map(state.patients.map(p => [p.patientId, p]));

    const consultsByPkg = new Map();
    for (const c of state.consultations) {
      const arr = consultsByPkg.get(c.packageId) || [];
      arr.push(c);
      consultsByPkg.set(c.packageId, arr);
    }
    for (const [pkgId, arr] of consultsByPkg.entries()) {
      arr.sort((a,b) => String(a.date).localeCompare(String(b.date)));
      consultsByPkg.set(pkgId, arr);
    }

    const rows = state.packages
      .slice()
      .sort((a,b) => String(a.purchaseDate).localeCompare(String(b.purchaseDate)))
      .map(pkg => {
        const pat = patientMap.get(pkg.patientId);
        const patientName = pat ? `${pat.firstName} ${pat.lastName}` : "(липсващ пациент)";

        const consults = consultsByPkg.get(pkg.packageId) || [];
        const done = consults.length;
        const left = Math.max(0, Number(pkg.size) - done);
        const status = left > 0 ? "Активен" : "Изчерпан";

        const consultDatesList = consults.map(c => formatDate(c.date)).join(", ");

        return {
          "Пациент": patientName,
          "Дата покупка (пакет)": formatDate(pkg.purchaseDate),
          "Дати консултации": consultDatesList,
          "Проведени (в пакета)": done,
          "Оставащи (в пакета)": left,
          "Статус": status
        };
      });

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Packages");

    const filename = `phone-consultations-${todayISO()}.xlsx`;
    XLSX.writeFile(wb, filename);
    toast("ok", "Експорт готов", filename);
  }

  // Modal
  function showModal(show) {
    const b = el("modalBackdrop");
    b.classList.toggle("show", show);
    b.setAttribute("aria-hidden", show ? "false" : "true");
    if (!show) modalPkgId = null;
  }

  function openDetails(pkgId, silent=false) {
    const pkg = state.packages.find(p => p.packageId === pkgId);
    if (!pkg) {
      if (!silent) toast("err","Липсва пакет","Не е намерен.");
      return;
    }

    modalPkgId = pkgId;

    const patientName = getPatientName(pkg.patientId);
    const { used, left } = computePackageStats(pkg.packageId, pkg.size);

    el("modalTitle").textContent = "Детайли за пакет";
    el("modalSub").textContent = `${patientName} • покупка: ${formatDate(pkg.purchaseDate)}`;

    el("dPatient").textContent = patientName;
    el("dPurchase").textContent = formatDate(pkg.purchaseDate);
    el("dSize").textContent = String(Number(pkg.size));
    el("dDone").textContent = String(used);
    el("dLeft").textContent = String(left);
    el("dStatus").innerHTML = left > 0
      ? `<span class="badge ok"><span class="b"></span>Активен</span>`
      : `<span class="badge warn"><span class="b"></span>Изчерпан</span>`;
    el("dPkgId").textContent = pkg.packageId;

    const list = el("dList");
    list.innerHTML = "";
    const consults = state.consultations
      .filter(c => c.packageId === pkg.packageId)
      .slice()
      .sort((a,b) => String(a.date).localeCompare(String(b.date)));

    if (consults.length === 0) {
      list.innerHTML = `<div class="item" style="color:var(--muted);">Няма записани консултации.</div>`;
    } else {
      for (const c of consults) {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<span>${escapeHtml(formatDate(c.date))}</span>`;
        list.appendChild(div);
      }
    }

    const quickBtn = el("dQuickNewBtn");
    quickBtn.disabled = left > 0;
    quickBtn.title = left > 0 ? "Отключва се при Изчерпан" : "Добавя нов пакет (днес) със същия размер";

    showModal(true);
  }

  function closeModal() {
    showModal(false);
  }

  async function deletePackage(packageId) {
    const ok = confirm("Сигурен ли си, че искаш да изтриеш този пакет? Това ще изтрие и консултациите към него.");
    if (!ok) return;

    setBusy(true);
    try {
      await api("deletePackage", { packageId });
      toast("ok","Пакет изтрит","Данните са обновени.");
      closeModal();
      await refresh();
    } catch (e) {
      toast("err","Грешка", e.message);
    }
    setBusy(false);
  }

  async function quickNewPackageFromOld(oldPkgId) {
    const oldPkg = state.packages.find(p => p.packageId === oldPkgId);
    if (!oldPkg) return toast("err","Липсва пакет","Не е намерен.");

    const { left } = computePackageStats(oldPkg.packageId, oldPkg.size);
    if (left > 0) return toast("warn","Пакетът не е изчерпан","„Нов пакет“ се отключва при Изчерпан.");

    const patientName = getPatientName(oldPkg.patientId);
    const ok = confirm(`Да добавя ли нов пакет за ${patientName} (днес, размер: ${Number(oldPkg.size)})?`);
    if (!ok) return;

    setBusy(true);
    try {
      await api("addPackage", {
        patientId: oldPkg.patientId,
        purchaseDate: todayISO(),
        size: Number(oldPkg.size)
      });
      toast("ok","Нов пакет добавен", `${patientName} • ${formatDate(todayISO())}`);
      await refresh();
    } catch (e) {
      toast("err","Грешка", e.message);
    }
    setBusy(false);
  }

  // Wire up
  el("packageDate").value = todayISO();
  el("consultDate").value = todayISO();

  el("todayBtn").addEventListener("click", () => {
    el("consultDate").value = todayISO();
    toast("ok", "Дата зададена", "Консултация: днес");
  });

  el("clearPatientBtn").addEventListener("click", () => {
    el("fullName").value = "";
  });

  // Enter adds patient
  el("fullName").addEventListener("keydown", (e) => {
    if (e.key === "Enter") el("addPatientBtn").click();
  });

  el("search").addEventListener("input", renderTable);
  el("filterStatus").addEventListener("change", renderTable);
  el("sortBy").addEventListener("change", renderTable);

  el("exportBtn").addEventListener("click", exportToExcel);
  el("exportBtnTop").addEventListener("click", exportToExcel);
  el("modalExportBtn").addEventListener("click", exportToExcel);

  el("addPatientBtn").addEventListener("click", async () => {
    const full = (el("fullName").value || "").trim().replace(/\s+/g, " ");
    if (!full) return toast("warn","Липсва име","Въведи име и фамилия.");

    const parts = full.split(" ");
    if (parts.length < 2) return toast("warn","Непълно име","Въведи поне две думи (име и фамилия).");

    const firstName = parts[0];
    const lastName = parts.slice(1).join(" ");

    setBusy(true);
    try {
      await api("addPatient", { firstName, lastName });
      el("fullName").value = "";
      toast("ok","Пациент добавен", `${firstName} ${lastName}`);
      await refresh();
    } catch (e) {
      toast("err","Грешка", e.message);
    }
    setBusy(false);
  });

  el("addPackageBtn").addEventListener("click", async () => {
    const patientId = el("patientForPackage").value;
    const purchaseDate = el("packageDate").value;
    const size = Number(el("packageSize").value || 5);

    if (!patientId) return toast("warn","Няма пациент","Добави пациент първо.");
    if (!purchaseDate) return toast("warn","Липсва дата","Избери дата на покупка.");
    if (!Number.isFinite(size) || size < 1) return toast("warn","Невалиден размер","Въведи число >= 1.");

    setBusy(true);
    try {
      await api("addPackage", { patientId, purchaseDate, size });
      toast("ok","Пакет добавен", `${formatDate(purchaseDate)} • ${size} консултации`);
      await refresh();
    } catch (e) {
      toast("err","Грешка", e.message);
    }
    setBusy(false);
  });

  el("addConsultBtn").addEventListener("click", async () => {
    const patientId = el("patientForConsult").value;
    const date = el("consultDate").value;
    if (!patientId) return toast("warn","Няма пациент","Избери пациент.");
    if (!date) return toast("warn","Липсва дата","Избери дата.");

    setBusy(true);
    try {
      const r = await api("addConsultation", { patientId, date });
      if (r && typeof r.remaining !== "undefined") {
        const kind = Number(r.remaining) === 0 ? "warn" : "ok";
        toast(kind, "Консултация добавена", `Остават: ${r.remaining}`);
      } else {
        toast("ok", "Консултация добавена", formatDate(date));
      }
      await refresh();
    } catch (e) {
      toast("err","Грешка", e.message);
    }
    setBusy(false);
  });

  el("packagesTable").addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const action = btn.dataset.action;
    const id = btn.dataset.id;

    if (action === "deletePkg") return deletePackage(id);
    if (action === "details") return openDetails(id);
    if (action === "quickNew") return quickNewPackageFromOld(id);
  });

  // Modal close
  el("modalCloseBtn").addEventListener("click", closeModal);
  el("modalCloseBtn2").addEventListener("click", closeModal);
  el("modalBackdrop").addEventListener("click", (e) => {
    if (e.target === el("modalBackdrop")) closeModal();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modalPkgId) closeModal();
  });

  // Modal actions
  el("dDeleteBtn").addEventListener("click", () => {
    if (!modalPkgId) return;
    deletePackage(modalPkgId);
  });

  el("dQuickNewBtn").addEventListener("click", () => {
    if (!modalPkgId) return;
    quickNewPackageFromOld(modalPkgId);
  });

  refresh();
})();
</script>
</body>
</html>
