<!doctype html>
<html lang="bg">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <!-- Performance hints -->
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="/.netlify">
    
    <title>Телефонни консултации</title>

    <!-- Critical CSS only - above the fold -->
    <style>
      :root{
        --bg:#0b1220;
        --panel:#0f172a;
        --card:#0b1324;
        --card2:#0c152b;
        --border: rgba(148,163,184,.16);
        --text:#e5e7eb;
        --muted:#94a3b8;
        --muted2:#a8b3c7;
        --accent:#60a5fa;
        --ok:#22c55e;
        --warn:#f59e0b;
        --danger:#ef4444;
        --shadow: 0 10px 30px rgba(0,0,0,.35);
        --shadow2: 0 8px 18px rgba(0,0,0,.30);
        --radius: 16px;
        --ring: 0 0 0 3px rgba(96,165,250,.25);
        --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }

      *{ box-sizing:border-box; }
      html,body{ height:100%; margin:0; }

      body{
        font-family:var(--font);
        color:var(--text);
        background:
          radial-gradient(1200px 600px at 10% -10%, rgba(96,165,250,.18), transparent 60%),
          radial-gradient(900px 500px at 80% 0%, rgba(34,197,94,.10), transparent 55%),
          radial-gradient(800px 500px at 50% 110%, rgba(245,158,11,.10), transparent 55%),
          linear-gradient(180deg, #070b16, #050815);
      }

      .container{ max-width: 1200px; margin: 0 auto; padding: 22px; }

      .topbar{
        display:flex;
        gap:14px;
        align-items:center;
        justify-content:space-between;
        padding: 14px 16px;
        border:1px solid var(--border);
        background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.55));
        backdrop-filter: blur(10px);
        border-radius: 18px;
        box-shadow: var(--shadow2);
        position: sticky;
        top: 14px;
        z-index: 50;
      }

      .brand{ display:flex; align-items:center; gap:12px; min-width: 220px; }

      .logo{
        width:40px;
        height:40px;
        border-radius: 14px;
        background:
          radial-gradient(16px 16px at 30% 25%, rgba(96,165,250,.95), rgba(96,165,250,.05)),
          radial-gradient(18px 18px at 70% 70%, rgba(34,197,94,.85), rgba(34,197,94,.05)),
          linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
        border:1px solid rgba(255,255,255,.08);
        box-shadow: 0 10px 25px rgba(0,0,0,.35);
      }

      .brand h1{ margin:0; font-size: 16px; letter-spacing: .2px; }
    </style>

    <!-- Non-critical CSS loaded asynchronously -->
    <link rel="preload" href="data:text/css;base64,LmJ1c3ktb3ZlcmxheXtwb3NpdGlvbjpmaXhlZDtpbnNldDowO2Rpc3BsYXk6bm9uZTtiYWNrZ3JvdW5kOnJnYmEoMiw2LDIzLC4yNSk7YmFja2Ryb3AtZmlsdGVyOmJsdXIoMnB4KTt6LWluZGV4OjE1MH1ib2R5LmJ1c3kgLmJ1c3ktb3ZlcmxheXtkaXNwbGF5OmJsb2NrfS5zcGlubmVye3Bvc2l0aW9uOmFic29sdXRlO3JpZ2h0OjE4cHg7dG9wOjE4cHg7d2lkdGg6MzJweDtoZWlnaHQ6MzJweDtib3JkZXItcmFkaXVzOjk5OXB4O2JvcmRlcjozcHggc29saWQgcmdiYSgxNDgsMTYzLDE4NCwuMjUpO2JvcmRlci10b3AtY29sb3I6cmdiYSg5NiwxNjUsMjUwLC44NSk7YW5pbWF0aW9uOnNwaW4gMXMgbGluZWFyIGluZmluaXRlfUBrZXlmcmFtZXMgc3Bpbntmcm9te3RyYW5zZm9ybTpyb3RhdGUoMGRlZyl9dG97dHJhbnNmb3JtOnJvdGF0ZSgzNjBkZWcpfX0=" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="data:text/css;base64,LmJ1c3ktb3ZlcmxheXtwb3NpdGlvbjpmaXhlZDtpbnNldDowO2Rpc3BsYXk6bm9uZTtiYWNrZ3JvdW5kOnJnYmEoMiw2LDIzLC4yNSk7YmFja2Ryb3AtZmlsdGVyOmJsdXIoMnB4KTt6LWluZGV4OjE1MH1ib2R5LmJ1c3kgLmJ1c3ktb3ZlcmxheXtkaXNwbGF5OmJsb2NrfS5zcGlubmVye3Bvc2l0aW9uOmFic29sdXRlO3JpZ2h0OjE4cHg7dG9wOjE4cHg7d2lkdGg6MzJweDtoZWlnaHQ6MzJweDtib3JkZXItcmFkaXVzOjk5OXB4O2JvcmRlcjozcHggc29saWQgcmdiYSgxNDgsMTYzLDE4NCwuMjUpO2JvcmRlci10b3AtY29sb3I6cmdiYSg5NiwxNjUsMjUwLC44NSk7YW5pbWF0aW9uOnNwaW4gMXMgbGluZWFyIGluZmluaXRlfUBrZXlmcmFtZXMgc3Bpbntmcm9te3RyYW5zZm9ybTpyb3RhdGUoMGRlZyl9dG97dHJhbnNmb3JtOnJvdGF0ZSgzNjBkZWcpfX0="></noscript>

    <style>
      .searchbar{
        flex: 1;
        display:flex;
        align-items:center;
        gap:10px;
        padding: 10px 12px;
        border:1px solid var(--border);
        border-radius: 14px;
        background: rgba(2,6,23,.55);
        min-width: 260px;
      }

      .searchbar input{
        width: 100%;
        border:0;
        outline:0;
        background: transparent;
        color: var(--text);
        font-size: 14px;
        caret-color: var(--text);
      }

      .searchbar .hint{
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
      }

      .top-actions{
        display:flex;
        gap:10px;
        align-items:center;
      }

      .chip{
        display:flex;
        gap:8px;
        align-items:center;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(11,19,36,.55);
        color: var(--muted2);
        font-size: 12px;
      }

      .dot{
        width:8px;
        height:8px;
        border-radius:999px;
        background: var(--ok);
        box-shadow: 0 0 0 4px rgba(34,197,94,.12);
      }

      .dot.err{
        background: var(--danger);
        box-shadow: 0 0 0 4px rgba(239,68,68,.12);
      }

      .grid{
        margin-top: 16px;
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
        align-items: start;
      }

      @media (max-width: 980px){
        .grid{ grid-template-columns: 1fr; }
        .brand{ min-width: unset; }
        .searchbar{ min-width: unset; }
      }

      @media (max-width: 680px){
        .topbar{ flex-wrap: wrap; gap: 10px; }
        .brand{ min-width: 0; flex: 1 1 auto; }
        .top-actions{ margin-left: auto; flex: 0 0 auto; }
        .searchbar{ order: 3; flex: 1 1 100%; min-width: 0; }
        .searchbar .hint{ display:none; }
        .searchbar input{
          color: var(--text) !important;
          -webkit-text-fill-color: var(--text) !important;
        }
      }

      .card{
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(12,21,43,.80), rgba(11,19,36,.55));
        box-shadow: var(--shadow2);
        overflow:hidden;
      }

      .card-header{
        padding: 14px 14px 10px;
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:12px;
        border-bottom: 1px solid rgba(148,163,184,.10);
      }

      .card-title{
        margin: 0;
        font-size: 14px;
        letter-spacing: .2px;
      }

      .card-desc{
        margin: 4px 0 0;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.35;
      }

      .card-body{ padding: 14px; }

      .ops-grid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      @media (max-width: 780px){
        .ops-grid{ grid-template-columns: 1fr; }
      }

      .ops-panel{
        border: 1px solid rgba(148,163,184,.14);
        background: rgba(2,6,23,.22);
        border-radius: 14px;
        padding: 12px;
      }

      .ops-panel .form-grid{ gap: 10px; }

      .ops-title{
        font-size: 12px;
        color: var(--muted2);
        font-weight: 700;
        margin-bottom: 10px;
      }

      .form-grid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      @media (max-width: 540px){
        .form-grid{ grid-template-columns: 1fr; }
      }

      label{
        display:block;
        margin: 0 0 6px;
        font-size: 12px;
        color: var(--muted2);
      }

      input, select, button{
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(148,163,184,.18);
        background: rgba(2,6,23,.55);
        color: var(--text);
        outline: none;
        font-size: 14px;
      }

      input::placeholder{ color: rgba(148,163,184,.65); }

      input:focus, select:focus{
        box-shadow: var(--ring);
        border-color: rgba(96,165,250,.45);
      }

      select{
        appearance:none;
        background-image:
          linear-gradient(45deg, transparent 50%, rgba(148,163,184,.8) 50%),
          linear-gradient(135deg, rgba(148,163,184,.8) 50%, transparent 50%);
        background-position: calc(100% - 18px) calc(50% - 2px), calc(100% - 12px) calc(50% - 2px);
        background-size:6px 6px, 6px 6px;
        background-repeat:no-repeat;
        padding-right: 34px;
      }

      select option{ background:#0b1220; color:var(--text); }
      select option:checked{ background: rgba(96,165,250,.22); color: var(--text); }

      .btn-row{ display:flex; gap:10px; }

      .btn{
        cursor:pointer;
        transition: transform .05s ease, opacity .15s ease, background .15s ease, border-color .15s ease;
        user-select:none;
      }

      .btn:active{ transform: translateY(1px); }

      .btn.primary{
        border: 1px solid rgba(96,165,250,.45);
        background: linear-gradient(180deg, rgba(96,165,250,.22), rgba(96,165,250,.10));
      }

      .btn.primary:hover{ border-color: rgba(96,165,250,.7); }

      .btn.secondary{
        border: 1px solid rgba(148,163,184,.18);
        background: rgba(11,19,36,.45);
        color: var(--text);
      }

      .btn.secondary:hover{ border-color: rgba(148,163,184,.30); }

      .btn.danger{
        border: 1px solid rgba(239,68,68,.40);
        background: linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.06));
        color: #ffd9dd;
      }

      .btn.danger:hover{ border-color: rgba(239,68,68,.68); }

      .btn.small{
        padding: 8px 10px;
        font-size: 12px;
        border-radius: 11px;
      }

      .btn.inline{ width:auto; }
      .btn[disabled]{ opacity:.5; cursor:not-allowed; }

      @media (max-width: 780px){
        .btn{ padding: 12px 12px; }
      }

      .table-card{ margin-top: 14px; }

      .table-head{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap:12px;
        flex-wrap:wrap;
        padding: 14px;
        border-bottom: 1px solid rgba(148,163,184,.10);
      }

      .table-head .left h2{ margin:0; font-size: 14px; }

      .table-actions{
        display:flex;
        gap:10px;
        align-items:end;
        flex-wrap:wrap;
      }

      .table-wrap{ overflow:auto; }

      table{
        width:100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      th, td{
        padding: 12px 14px;
        text-align:left;
        border-bottom: 1px solid rgba(148,163,184,.10);
        white-space: nowrap;
      }

      th{
        position: sticky;
        top: 0;
        background: rgba(15,23,42,.85);
        backdrop-filter: blur(10px);
        font-size: 12px;
        color: var(--muted2);
        z-index: 1;
      }

      tr:hover td{ background: rgba(96,165,250,.05); }
      td.right, th.right{ text-align:right; }

      .badge{
        display:inline-flex;
        align-items:center;
        gap:6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(148,163,184,.18);
        background: rgba(2,6,23,.28);
        font-size: 12px;
        color: var(--muted2);
      }

      .badge .b{ width:8px; height:8px; border-radius:999px; }
      .badge.ok{ border-color: rgba(34,197,94,.25); }
      .badge.ok .b{ background: var(--ok); }
      .badge.warn{ border-color: rgba(245,158,11,.25); }
      .badge.warn .b{ background: var(--warn); }

      .mono{ font-family: var(--mono); }

      .toast{
        position: fixed;
        right: 18px;
        bottom: 18px;
        min-width: 260px;
        max-width: 420px;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(15,23,42,.92);
        box-shadow: var(--shadow);
        display:none;
        z-index: 200;
      }

      .toast.show{ display:block; }
      .toast .t{ font-size: 13px; margin:0; }
      .toast .d{ font-size: 12px; color: var(--muted); margin-top: 4px; }
      .toast.ok{ border-color: rgba(34,197,94,.25); }
      .toast.warn{ border-color: rgba(245,158,11,.25); }
      .toast.err{ border-color: rgba(239,68,68,.30); }

      .modal-backdrop{
        position: fixed;
        inset: 0;
        display:none;
        background: rgba(2,6,23,.55);
        backdrop-filter: blur(6px);
        z-index: 300;
        padding: 18px;
      }

      .modal-backdrop.show{
        display:flex;
        align-items:center;
        justify-content:center;
      }

      .modal{
        width: min(860px, 100%);
        border-radius: 18px;
        border: 1px solid rgba(148,163,184,.18);
        background: linear-gradient(180deg, rgba(15,23,42,.95), rgba(11,19,36,.85));
        box-shadow: var(--shadow);
        overflow:hidden;
      }

      .modal-header{
        padding: 14px 14px 10px;
        border-bottom: 1px solid rgba(148,163,184,.10);
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:12px;
      }

      .modal-title{ margin:0; font-size: 14px; }
      .modal-sub{ margin-top:4px; font-size:12px; color: var(--muted); }
      .modal-body{ padding: 14px; }

      .modal-footer{
        padding: 12px 14px;
        border-top: 1px solid rgba(148,163,184,.10);
        display:flex;
        justify-content:space-between;
        gap:10px;
        flex-wrap:wrap;
      }

      .modal-grid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      @media (max-width: 780px){
        .modal-grid{ grid-template-columns: 1fr; }
        .modal-footer{ gap: 12px; }
      }

      .panel{
        border: 1px solid rgba(148,163,184,.14);
        background: rgba(2,6,23,.25);
        border-radius: 14px;
        padding: 12px;
      }

      .panel h3{
        margin:0 0 8px;
        font-size: 12px;
        color: var(--muted2);
        font-weight: 600;
      }

      .list{
        max-height: 220px;
        overflow:auto;
        border: 1px solid rgba(148,163,184,.10);
        border-radius: 12px;
        background: rgba(2,6,23,.18);
        padding: 8px;
      }

      .list .item{
        padding: 8px 10px;
        border-radius: 10px;
        display:flex;
        justify-content:space-between;
        gap:10px;
        color: var(--muted2);
        border: 1px solid transparent;
      }

      .list .item:hover{
        background: rgba(96,165,250,.05);
        border-color: rgba(96,165,250,.12);
      }

      .kv{
        display:grid;
        grid-template-columns: 170px 1fr;
        gap: 8px 10px;
        font-size: 13px;
      }

      .kv .k{ color: var(--muted); }
    </style>
  </head>

  <body>
    <div class="busy-overlay"><div class="spinner"></div></div>

    <div class="container">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>Телефонни консултации</h1>
          </div>
        </div>

        <div class="searchbar" title="Филтрира таблицата по пациент">
          <span class="mono" style="color:var(--muted);font-size:12px;">⌕</span>
          <input id="search" placeholder="Търсене по пациент..." />
          <span class="hint">Enter</span>
        </div>

        <div class="top-actions">
          <div class="chip"><span class="dot" id="connDot"></span><span id="connText">Свързан</span></div>
          <button class="btn secondary inline" id="exportBtnTop" type="button">Експорт</button>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="card-title">Нов пациент</h2>
              <div class="card-desc">Добави пациент с име и фамилия.</div>
            </div>
          </div>

          <div class="card-body">
            <div class="form-grid">
              <div style="grid-column:1 / -1;">
                <label>Име и фамилия</label>
                <input id="fullName" placeholder="напр. Иван Петров" />
              </div>
            </div>

            <div style="margin-top:12px;" class="btn-row">
              <button class="btn primary" id="addPatientBtn" type="button">Добави пациент</button>
              <button class="btn secondary" id="clearPatientBtn" type="button">Изчисти</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="form-grid" style="grid-template-columns: 1fr;">
              <div>
                <label>Пациент</label>
                <select id="patientSelected"></select>
              </div>
            </div>

            <div class="ops-grid" style="margin-top:12px;">
              <div class="ops-panel">
                <div class="ops-title">Добави пакет</div>

                <div class="form-grid">
                  <div>
                    <label>Дата на покупка</label>
                    <input type="date" id="packageDate" />
                  </div>

                  <div>
                    <label>Брой консултации</label>
                    <input type="number" id="packageSize" value="5" min="1" />
                  </div>

                  <div style="grid-column:1 / -1;">
                    <button class="btn primary" id="addPackageBtn" type="button">Добави пакет</button>
                  </div>
                </div>
              </div>

              <div class="ops-panel">
                <div class="ops-title">Добави консултация</div>

                <div class="form-grid">
                  <div>
                    <label>Дата на консултация</label>
                    <input type="date" id="consultDate" />
                  </div>

                  <div style="display:flex; align-items:end;">
                    <button class="btn secondary" id="todayBtn" type="button">Днес</button>
                  </div>

                  <div style="grid-column:1 / -1;">
                    <button class="btn primary" id="addConsultBtn" type="button">Добави консултация</button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="card table-card" style="margin-top:14px;">
        <div class="table-head">
          <div class="left">
            <h2>Отчет по пакети</h2>
          </div>

          <div class="table-actions">
            <div>
              <label>Филтър</label>
              <select id="filterStatus">
                <option value="all">Всички</option>
                <option value="active">Само активни</option>
                <option value="exhausted">Само изчерпани</option>
              </select>
            </div>

            <div>
              <label>Сортиране</label>
              <select id="sortBy">
                <option value="date_desc">Дата (нови → стари)</option>
                <option value="date_asc">Дата (стари → нови)</option>
                <option value="patient_asc">Пациент (A → Я)</option>
                <option value="status">Статус (Активен → Изчерпан)</option>
              </select>
            </div>

            <div style="display:flex;align-items:end;">
              <button class="btn secondary inline" id="exportBtn" type="button">Експорт (Excel)</button>
            </div>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Пациент</th>
                <th>Пакет</th>
                <th>Статус</th>
                <th>Проведени / Остават</th>
                <th class="right">Действия</th>
              </tr>
            </thead>
            <tbody id="packagesTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-header">
          <div>
            <h2 class="modal-title" id="modalTitle">Детайли</h2>
            <div class="modal-sub" id="modalSub">—</div>
          </div>
          <button class="btn secondary small inline" id="modalCloseBtn" type="button">Затвори</button>
        </div>

        <div class="modal-body">
          <div class="modal-grid">
            <div class="panel">
              <h3>Обобщение</h3>

              <div class="kv">
                <div class="k">Пациент</div><div id="dPatient">—</div>
                <div class="k">Покупка</div><div id="dPurchase">—</div>
                <div class="k">Размер</div><div id="dSize">—</div>
                <div class="k">Проведени</div><div id="dDone">—</div>
                <div class="k">Оставащи</div><div id="dLeft">—</div>
                <div class="k">Статус</div><div id="dStatus">—</div>
              </div>

              <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn primary small inline" id="dQuickNewBtn" type="button">Нов пакет (бързо)</button>
                <button class="btn danger small inline" id="dDeleteBtn" type="button">Изтрий пакет</button>
              </div>

              <div style="margin-top:10px; font-size:12px; color:var(--muted);">
                "Нов пакет (бързо)" се активира само когато пакетът е изчерпан.
              </div>
            </div>

            <div class="panel">
              <h3>Консултации (дати)</h3>
              <div class="list" id="dList"></div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
